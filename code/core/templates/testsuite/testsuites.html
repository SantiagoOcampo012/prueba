{% extends 'base.html' %}
{% load static %}

{% block title %}TestSuites - Sistema de Gestión{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/testsuite/testsuite.css' %}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Added info section for consistency -->
    <div class="info-section-header">
        <div class="page-header">
            <div class="header-content-main">
                <h1><i class="fas fa-flask"></i> Gestión de Test Suites</h1>
                <p class="header-subtitle">Administra y organiza los suites de prueba de tus proyectos</p>
            </div>
            <button class="btn-primary" onclick="abrirModalCrear()">
                <i class="fas fa-plus"></i> Nuevo Test Suite
            </button>
        </div>

        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Grid positioned below header section -->
    <div class="testsuite-grid">
        {% for testsuite in testsuites %}
        <div class="testsuite-card" data-id="{{ testsuite.id }}">
            <div class="card-header-custom">
                <div class="card-icon">
                    <i class="fas fa-flask"></i>
                </div>
                <div class="card-info">
                    <h3>{{ testsuite.nombre }}</h3>
                    <div class="badges-row">
                        <span class="badge badge-info">{{ testsuite.proyecto.nombre }}</span>
                    </div>
                </div>
            </div>
            <div class="card-body-custom">
                <p class="card-description">{{ testsuite.descripcion|truncatewords:20 }}</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <i class="fas fa-tasks"></i>
                        <span>{{ testsuite.casoprueba_set.count }} Casos</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-calendar"></i>
                        <span>{{ testsuite.creacion|date:"d/m/Y" }}</span>
                    </div>
                </div>
            </div>
            <div class="card-actions">
                <!-- Cambiar botón Ver para navegar a página de detalle -->
                <a href="{% url 'testsuite:detalle_testsuite' testsuite.id %}" class="btn-secondary btn-sm">
                    <i class="fas fa-eye"></i> Ver
                </a>
                <button class="btn-primary btn-sm" onclick="abrirModalEditar({{ testsuite.id }}, '{{ testsuite.nombre|escapejs }}', '{{ testsuite.descripcion|escapejs }}', {{ testsuite.proyecto.id }})">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn-danger btn-sm" onclick="confirmarEliminar({{ testsuite.id }}, '{{ testsuite.nombre|escapejs }}')">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>No hay Test Suites creados aún</p>
            <button class="btn-primary" onclick="abrirModalCrear()">Crear el primero</button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para Crear/Editar -->
<div id="modalForm" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Nuevo Test Suite</h2>
            <span class="modal-close" onclick="cerrarModalForm()">&times;</span>
        </div>
        <form id="formTestSuite" method="POST" action="{% url 'testsuite:crear_testsuite' %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label for="id_nombre">Nombre</label>
                    {{ form.nombre }}
                </div>
                <div class="form-group">
                    <label for="id_descripcion">Descripción</label>
                    {{ form.descripcion }}
                </div>
                <div class="form-group">
                    <label for="id_proyecto">Proyecto</label>
                    {{ form.proyecto }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModalForm()">Cancelar</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Confirmar Eliminación -->
<div id="modalEliminar" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Confirmar Eliminación</h2>
            <span class="modal-close" onclick="cerrarModalEliminar()">&times;</span>
        </div>
        <form id="formEliminar" method="POST" action="">
            {% csrf_token %}
            <div class="modal-body">
                <div class="confirm-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>¿Está seguro que desea eliminar el Test Suite <strong id="nombreEliminar"></strong>?</p>
                    <p class="text-muted">Esta acción no se puede deshacer.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModalEliminar()">Cancelar</button>
                <button type="submit" class="btn-danger">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function abrirModalCrear() {
    document.getElementById('modalTitle').textContent = 'Nuevo Test Suite';
    document.getElementById('formTestSuite').action = '{% url "testsuite:crear_testsuite" %}';
    document.getElementById('formTestSuite').reset();
    document.getElementById('modalForm').style.display = 'flex';
}

function abrirModalEditar(id, nombre, descripcion, proyectoId) {
    document.getElementById('modalTitle').textContent = 'Editar Test Suite';
    document.getElementById('formTestSuite').action = `/testsuite/testsuites/${id}/editar/`;
    document.getElementById('id_nombre').value = nombre;
    document.getElementById('id_descripcion').value = descripcion;
    document.getElementById('id_proyecto').value = proyectoId;
    document.getElementById('modalForm').style.display = 'flex';
}

function cerrarModalForm() {
    document.getElementById('modalForm').style.display = 'none';
}

function confirmarEliminar(id, nombre) {
    document.getElementById('nombreEliminar').textContent = nombre;
    document.getElementById('formEliminar').action = `/testsuite/testsuites/${id}/eliminar/`;
    document.getElementById('modalEliminar').style.display = 'flex';
}

function cerrarModalEliminar() {
    document.getElementById('modalEliminar').style.display = 'none';
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const messages = document.querySelectorAll('.alert');
    messages.forEach(function(message) {
        setTimeout(function() {
            message.style.opacity = '0';
            setTimeout(function() {
                message.remove();
            }, 300);
        }, 5000);
    });
});
</script>
{% endblock %}
